<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>simuclustfactor.tandem &mdash; simuclustfactor 0.0.3 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> simuclustfactor
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">simuclustfactor</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">simuclustfactor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>simuclustfactor.tandem</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for simuclustfactor.tandem</h1><div class="highlight"><pre>
<span></span><span class="c1">### ---- IMPORTING MODULES</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.tensor</span> <span class="kn">import</span> <span class="n">Fold</span><span class="p">,</span> <span class="n">Unfold</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">EigenVectors</span><span class="p">,</span> <span class="n">PseudoF_Full</span><span class="p">,</span> <span class="n">PseudoF_Reduced</span><span class="p">,</span> <span class="n">_BaseClass</span><span class="p">,</span> <span class="n">OneKMeans</span><span class="p">,</span> <span class="n">RandomMembershipMatrix</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>


<span class="c1"># === The TWCFTA MODEL</span>
<div class="viewcode-block" id="TWCFTA"><a class="viewcode-back" href="../../simuclustfactor.html#simuclustfactor.tandem.TWCFTA">[docs]</a><span class="k">class</span> <span class="nc">TWCFTA</span><span class="p">(</span><span class="n">_BaseClass</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Three-way Clustering-Factorial Tandem model (TWCFTA).</span>
<span class="sd">		- Perform KMeans on X_i_jk to obtain membership matrix U_i_g and centroids X_g_jk in full space.</span>
<span class="sd">		- Obtain Y_g_qr and C_k_r &amp; B_j_q factor matrices that maximizes the reconstruction of U_i_g.X_g_jk via Tucker2.</span>
<span class="sd">	</span>
<span class="sd">	:param int n_max_iter: Maximum number of iterations. Defaults to 10.</span>
<span class="sd">	:param int n_loops: Number of random initializations to gurantee global results. Defaults to 10.</span>
<span class="sd">	:param float tol: Tolerance level/acceptable error. Defaults to 1e-3.</span>
<span class="sd">	:param bool seed: Seed for random sequence generation. Defaults to None.</span>
<span class="sd">	:param bool verbose: Whether to display executions output or not. Defaults to False.</span>
<span class="sd">	:param ndarray U_i_g0: (I,G) initial stochastic membership function matrix.</span>
<span class="sd">	:param ndarray B_j_q0: (J,Q) initial component weight matrix for variables.</span>
<span class="sd">	:param ndarray C_k_r0: (K,R) initial component weight matrix for occasions.</span>

<span class="sd">	:return: Initialized TWCFTA model.</span>

<span class="sd">	.. note::</span>
<span class="sd">		- This procedure is useful to further interpret the between clusters variability of the data and to understand the variables and/or occasions that most contribute to discriminate the clusters. However, the application of this technique could lead to the masking of variables that are not informative of the clustering structure.</span>

<span class="sd">		- Since the Tucker2 model is applied after the clustering, this cannot help select the most relevant information for the clustering in the dataset.</span>

<span class="sd">	:references:</span>
<span class="sd">		[1] Tucker L. (1966)</span>
<span class="sd">		Some mathematical notes on three-mode factor analysis</span>
<span class="sd">		Psychometrika, 31(3), 279-311. `10.1007/BF02289464 &lt;https://doi.org/10.1007/BF02289464&gt;`_. </span>

<span class="sd">		[2] Arabie P, Hubert L (1996)</span>
<span class="sd">		Advances in Cluster Analysis Relevant to Marketing Research</span>
<span class="sd">		In: Gaul, W., Pfeifer, D. (eds) From Data to Knowledge. Studies in Classification, Data Analysis, and Knowledge Organization. Springer, Berlin, Heidelberg.</span>
<span class="sd">		`10.1007/978-3-642-79999-0_1 &lt;https://doi.org/10.1007/978-3-642-79999-0_1&gt;`_. </span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="o">*</span><span class="n">args</span><span class="p">,</span>
		<span class="o">**</span><span class="n">kwargs</span>
	<span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
			<span class="o">*</span><span class="n">args</span><span class="p">,</span>
			<span class="o">**</span><span class="n">kwargs</span>
		<span class="p">)</span>

	<span class="c1"># Fitting the model &amp; estimating parameters.</span>
<div class="viewcode-block" id="TWCFTA.fit"><a class="viewcode-back" href="../../simuclustfactor.html#simuclustfactor.tandem.TWCFTA.fit">[docs]</a>	<span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_i_jk</span><span class="p">,</span> <span class="n">full_tensor_shape</span><span class="p">,</span> <span class="n">reduced_tensor_shape</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		:param ndarray X_i_jk: (I,JK) mode-1 matricized three-way arrays with frontal slabs next to each other. It is column centered.</span>
<span class="sd">		:param tuple full_tensor_shape: (I,J,K) dimensions of the original tensor.</span>
<span class="sd">		:param tuple reduced_tensor_shape: (G,Q,R) dimensions of centroids tensor.</span>

<span class="sd">		:return:</span>
<span class="sd">			- U_i_g0 - Initial object membership function matrix.</span>
<span class="sd">			- B_j_q0 - Initial factor/component matrix for the variables.</span>
<span class="sd">			- C_k_r0 - Initial factor/component matrix for the occasions.</span>
<span class="sd">			- U_i_g - Final/updated object membership function matrix.</span>
<span class="sd">			- B_j_q - Final/updated factor/component matrix for the variables.</span>
<span class="sd">			- C_k_r - Final/updated factor/component matrix for the occasions.</span>
<span class="sd">			- Y_g_qr - Derived centroids in the reduced space (data matrix).</span>
<span class="sd">			- X_i_jk_scaled - Standardized dataset matrix.</span>
<span class="sd">			- BestTimeElapsed - Execution time for the best iterate.</span>
<span class="sd">			- BestLoop - Loop that obtained the best iterate.</span>
<span class="sd">			- BestKmIteration - Number of iteration until best iterate for the K-means.</span>
<span class="sd">			- BestFaIteration - Number of iteration until best iterate for the FA.</span>
<span class="sd">			- FaConverged - Flag to check if algorithm converged for the K-means.</span>
<span class="sd">			- KmConverged - Flag to check if algorithm converged for the Factor Decomposition.</span>
<span class="sd">			- nKmConverges - Number of loops that converged for the K-means.</span>
<span class="sd">			- nFaConverges - Number of loops that converged for the Factor decomposition.</span>
<span class="sd">			- TSS_full - Total deviance in the full-space.</span>
<span class="sd">			- BSS_full - Between deviance in the reduced-space.</span>
<span class="sd">			- RSS_full - Residual deviance in the reduced-space.</span>
<span class="sd">			- PF_full - PseudoF in the full-space.</span>
<span class="sd">			- TSS_reduced - Total deviance in the reduced-space.</span>
<span class="sd">			- BSS_reduced - Between deviance in the reduced-space.</span>
<span class="sd">			- RSS_reduced - Residual deviance in the reduced-space.</span>
<span class="sd">			- PF_reduced - PseudoF in the reduced-space.</span>
<span class="sd">			- PF - Actual PseudoF value to obtain best loop.</span>
<span class="sd">			- Labels - Object cluster assignments.</span>
<span class="sd">			- FsKM - Objective function values for the KM best iterate.</span>
<span class="sd">			- FsFA - Objective function values for the FA best iterate.</span>
<span class="sd">			- Enorm - Average l2 norm of the residual norm.</span>

<span class="sd">		:Example:</span>
<span class="sd">			&gt;&gt;&gt; from generate_dataset import GenerateDataset</span>
<span class="sd">			&gt;&gt;&gt; seed = 106382</span>
<span class="sd">			&gt;&gt;&gt; full_tensor_shape = (8,5,4)</span>
<span class="sd">			&gt;&gt;&gt; reduced_tensor_shape = (3,3,2)</span>
<span class="sd">			&gt;&gt;&gt; X_i_jk = GenerateDataset(full_tensor_shape, reduced_tensor_shape, seed=seed).additive_noise().X_i_jk</span>
<span class="sd">			&gt;&gt;&gt; model = TWCFTA(verbose=False)</span>
<span class="sd">			&gt;&gt;&gt; cf = model.fit(X_i_jk, full_tensor_shape, reduced_tensor_shape)</span>
<span class="sd">			&gt;&gt;&gt; cf.Y_g_qr</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1"># ------------ Initialization ------------</span>

		<span class="c1"># initializing basic config</span>
		<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>  <span class="c1"># random number generator</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">reduced_tensor_shape</span> <span class="o">=</span> <span class="n">reduced_tensor_shape</span>  <span class="c1"># (I,J,K) tensor shape</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">full_tensor_shape</span> <span class="o">=</span> <span class="n">full_tensor_shape</span>  <span class="c1"># (G,Q,R) core tensor shape</span>

		<span class="c1"># check parameters and arguments</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_check_params</span><span class="p">()</span>
		<span class="c1"># self._check_initialized_components()</span>
		<span class="n">X_i_jk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_i_jk</span><span class="p">)</span>
		
		<span class="c1"># Declaring I,J,K and G,Q,R</span>
		<span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span> <span class="o">=</span> <span class="n">full_tensor_shape</span>
		<span class="n">G</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="n">reduced_tensor_shape</span>

		<span class="c1"># standardizing the dataset X_i_jk</span>
		<span class="n">X_scaled</span> <span class="o">=</span> <span class="n">X_i_jk</span> <span class="o">-</span> <span class="n">X_i_jk</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">X_i_jk</span> <span class="o">=</span> <span class="n">X_scaled</span><span class="o">/</span><span class="p">((</span><span class="n">X_scaled</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">I</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

		<span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Loop&#39;</span><span class="p">,</span><span class="s1">&#39;Best KM Iter&#39;</span><span class="p">,</span><span class="s1">&#39;Best FA Iter&#39;</span><span class="p">,</span><span class="s1">&#39;Loop time&#39;</span><span class="p">,</span> <span class="s1">&#39;BSS Full (%)&#39;</span><span class="p">,</span> <span class="s1">&#39;BSS Reduced (%)&#39;</span><span class="p">,</span> <span class="s1">&#39;PseudoF Full&#39;</span><span class="p">,</span> <span class="s1">&#39;PseudoF Reduced&#39;</span><span class="p">,</span> <span class="s1">&#39;KM Converged&#39;</span><span class="p">,</span><span class="s1">&#39;FA Converged&#39;</span><span class="p">]</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">([],</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">))</span>

		<span class="n">n_faConverges</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of converges for factor analysis</span>
		<span class="n">n_kmConverges</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of converges for kmeans</span>

		<span class="c1"># ------------ Loop/Run Start ------------</span>

		<span class="c1"># Factorial reduction on centroids (via T2 applied to the centroids matrix X_g_jk_bar)</span>
		<span class="k">for</span> <span class="n">loop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_loops</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
			
			<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

			<span class="c1"># ------------ KMeans Clustering ------------</span>
			
			<span class="c1"># given directly as paramters</span>
			<span class="n">U_i_g0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U_i_g</span>
			<span class="n">km_iter</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">km_converged</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="n">Fs_km</span> <span class="o">=</span> <span class="p">[]</span>

			<span class="c1"># random init if not specified</span>
			<span class="k">if</span> <span class="n">U_i_g0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">U_i_g0</span> <span class="o">=</span> <span class="n">RandomMembershipMatrix</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
			
			<span class="n">U_i_g_init</span> <span class="o">=</span> <span class="n">U_i_g0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

			<span class="c1"># initial objective</span>
			<span class="n">X_g_jk0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">U_i_g0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">@</span> <span class="n">U_i_g0</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X_i_jk</span>  <span class="c1"># compute centroids matrix</span>
			<span class="n">F0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">U_i_g0</span><span class="nd">@X_g_jk0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># objective maximization</span>
			<span class="n">Fs_km</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F0</span><span class="p">)</span>		

			<span class="c1"># clustering on objects (via KMeans applied to X_i_jk)</span>
			<span class="n">conv</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span>
			
			<span class="c1"># iterates init</span>
			<span class="n">best_km_iter</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="n">best_U_i_g</span> <span class="o">=</span> <span class="n">U_i_g0</span>

			<span class="k">while</span> <span class="n">conv</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">:</span>
				
				<span class="n">km_iter</span> <span class="o">+=</span> <span class="mi">1</span>

				<span class="c1"># get random centroids</span>
				<span class="n">U_i_g</span> <span class="o">=</span> <span class="n">OneKMeans</span><span class="p">(</span><span class="n">X_i_jk</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">U_i_g</span><span class="o">=</span><span class="n">U_i_g0</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>  <span class="c1"># updated membership matrix</span>
				<span class="n">X_g_jk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">U_i_g</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">@</span> <span class="n">U_i_g</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X_i_jk</span>  <span class="c1"># compute centroids matrix</span>

				<span class="c1"># check if maximizes orbjective or minimizes the loss</span>
				<span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">U_i_g</span> <span class="o">@</span> <span class="n">X_g_jk</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># initial objective				</span>
				<span class="n">conv</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">F</span><span class="o">-</span><span class="n">F0</span><span class="p">)</span>

				<span class="k">if</span> <span class="n">F</span> <span class="o">&gt;=</span> <span class="n">F0</span><span class="p">:</span>
					<span class="n">F0</span> <span class="o">=</span> <span class="n">F</span>
					<span class="n">Fs_km</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>						
					<span class="n">best_U_i_g</span> <span class="o">=</span> <span class="n">U_i_g</span>
					<span class="n">best_km_iter</span> <span class="o">=</span> <span class="n">km_iter</span>				

				<span class="k">if</span> <span class="n">conv</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">:</span>
					<span class="n">km_converged</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="n">n_kmConverges</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="k">break</span>

				<span class="k">if</span> <span class="n">km_iter</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_max_iter</span><span class="p">:</span>
					<span class="c1"># if self.verbose: print(&quot;KM Maximum iterations reached.&quot;)</span>
					<span class="k">break</span>

				<span class="n">U_i_g0</span> <span class="o">=</span> <span class="n">U_i_g</span>
			
			<span class="c1"># updated centroids</span>
			<span class="n">X_g_jk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">best_U_i_g</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">@</span> <span class="n">best_U_i_g</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X_i_jk</span>  <span class="c1"># compute centroids matrix						</span>

			<span class="c1"># ------------ Factor Decomposition ------------</span>

			<span class="n">fa_converged</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="n">fa_iter</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">Fs_fa</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># objective function values</span>

			<span class="c1"># matricize centroid tensor</span>
			<span class="n">X_k_g_j</span> <span class="o">=</span> <span class="n">Fold</span><span class="p">(</span><span class="n">X_g_jk</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">J</span><span class="p">))</span>
			<span class="n">X_j_kg</span> <span class="o">=</span> <span class="n">Unfold</span><span class="p">(</span><span class="n">X_k_g_j</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
			<span class="n">X_k_gj</span> <span class="o">=</span> <span class="n">Unfold</span><span class="p">(</span><span class="n">X_k_g_j</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

			<span class="c1"># as direct input</span>
			<span class="n">B_j_q0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_j_q</span>
			<span class="n">C_k_r0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_k_r</span>

			<span class="c1"># initialize B and C</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">==</span> <span class="s1">&#39;svd&#39;</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">B_j_q0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">B_j_q0</span> <span class="o">=</span> <span class="n">EigenVectors</span><span class="p">(</span><span class="n">X_j_kg</span><span class="nd">@X_j_kg</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">C_k_r0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">C_k_r0</span> <span class="o">=</span> <span class="n">EigenVectors</span><span class="p">(</span><span class="n">X_k_gj</span><span class="nd">@X_k_gj</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>  <span class="c1"># random initialization	</span>
				<span class="k">if</span> <span class="n">B_j_q0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">B_rand</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">([</span><span class="n">J</span><span class="p">,</span><span class="n">J</span><span class="p">])</span>
					<span class="n">B_j_q0</span> <span class="o">=</span> <span class="n">EigenVectors</span><span class="p">(</span><span class="n">B_rand</span> <span class="o">@</span> <span class="n">B_rand</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
					<span class="k">del</span> <span class="n">B_rand</span>
				<span class="k">if</span> <span class="n">C_k_r0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">C_rand</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">([</span><span class="n">K</span><span class="p">,</span><span class="n">K</span><span class="p">])</span>
					<span class="n">C_k_r0</span> <span class="o">=</span> <span class="n">EigenVectors</span><span class="p">(</span><span class="n">C_rand</span> <span class="o">@</span> <span class="n">C_rand</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
					<span class="k">del</span> <span class="n">C_rand</span>
			
			<span class="n">I_g_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

			<span class="c1"># to return as initializers</span>
			<span class="n">B_j_q_init</span> <span class="o">=</span> <span class="n">B_j_q0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="n">C_k_r_init</span> <span class="o">=</span> <span class="n">C_k_r0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

			<span class="c1"># updated centroids matrix</span>
			<span class="n">Z_g_jk</span> <span class="o">=</span> <span class="n">X_g_jk</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">C_k_r0</span><span class="nd">@C_k_r0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">B_j_q0</span><span class="nd">@B_j_q0</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

			<span class="n">F0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Z_g_jk</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
			<span class="n">Fs_fa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F0</span><span class="p">)</span>
			<span class="n">conv</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span>
			
			<span class="c1"># iterates init</span>
			<span class="n">best_fa_iter</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="n">best_B_j_q</span> <span class="o">=</span> <span class="n">B_j_q0</span>
			<span class="n">best_C_k_r</span> <span class="o">=</span> <span class="n">C_k_r0</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">conv</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">):</span>				

				<span class="n">fa_iter</span> <span class="o">+=</span> <span class="mi">1</span>

				<span class="c1"># updating B_j_q</span>
				<span class="n">B_j_j</span> <span class="o">=</span> <span class="n">X_j_kg</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">I_g_g</span><span class="p">,</span> <span class="n">C_k_r0</span><span class="nd">@C_k_r0</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">@</span> <span class="n">X_j_kg</span><span class="o">.</span><span class="n">T</span>
				<span class="n">B_j_q</span> <span class="o">=</span> <span class="n">EigenVectors</span><span class="p">(</span><span class="n">B_j_j</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>

				<span class="c1"># updating C_k_r</span>
				<span class="n">C_k_k</span> <span class="o">=</span> <span class="n">X_k_gj</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">B_j_q</span><span class="nd">@B_j_q</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">I_g_g</span><span class="p">)</span> <span class="o">@</span> <span class="n">X_k_gj</span><span class="o">.</span><span class="n">T</span>
				<span class="n">C_k_r</span> <span class="o">=</span> <span class="n">EigenVectors</span><span class="p">(</span><span class="n">C_k_k</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>

				<span class="c1"># updated centroids matrix</span>
				<span class="n">Z_g_jk</span> <span class="o">=</span> <span class="n">X_g_jk</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">C_k_r</span><span class="nd">@C_k_r</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">B_j_q</span><span class="nd">@B_j_q</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

				<span class="c1"># compute L2 norm of reconstruction error</span>
				<span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Z_g_jk</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>				
				<span class="n">conv</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">F</span><span class="o">-</span><span class="n">F0</span><span class="p">)</span>

				<span class="c1"># convergence check</span>
				<span class="k">if</span> <span class="n">F</span> <span class="o">&gt;=</span> <span class="n">F0</span><span class="p">:</span>
					<span class="n">Fs_fa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
					<span class="n">F0</span> <span class="o">=</span> <span class="n">F</span>
					<span class="n">best_B_j_q</span> <span class="o">=</span> <span class="n">B_j_q</span>
					<span class="n">best_C_k_r</span> <span class="o">=</span> <span class="n">C_k_r</span>
					<span class="n">best_fa_iter</span> <span class="o">=</span> <span class="n">fa_iter</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">conv</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">):</span>
					<span class="n">fa_converged</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="n">n_faConverges</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="k">break</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">fa_iter</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_max_iter</span><span class="p">):</span>
					<span class="c1"># if self.verbose: print(&quot;FA Maximum iterations reached.&quot;)</span>
					<span class="k">break</span>

				<span class="n">B_j_q0</span> <span class="o">=</span> <span class="n">B_j_q</span>
				<span class="n">C_k_r0</span> <span class="o">=</span> <span class="n">C_k_r</span>

			<span class="c1"># ----------- Compute metrics for loop/run --------------</span>

			<span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span>

			<span class="c1"># updating X</span>
			<span class="n">Y_i_qr</span> <span class="o">=</span> <span class="n">X_i_jk</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">best_C_k_r</span><span class="p">,</span> <span class="n">best_B_j_q</span><span class="p">)</span>
			<span class="n">Z_i_qr</span> <span class="o">=</span> <span class="n">best_U_i_g</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">best_U_i_g</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">@</span> <span class="n">best_U_i_g</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y_i_qr</span>
			<span class="n">Z_i_jk</span> <span class="o">=</span> <span class="n">Z_i_qr</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">best_C_k_r</span><span class="p">,</span> <span class="n">best_B_j_q</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

			<span class="n">TSS_full</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_i_jk</span> <span class="o">@</span> <span class="n">X_i_jk</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="c1"># X_i_jk@X_i_jk.size</span>
			<span class="n">BSS_full</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z_i_jk</span> <span class="o">@</span> <span class="n">Z_i_jk</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="c1"># Z_i_jk.var()*Z_i_jk.size</span>
			<span class="n">RSS_full</span> <span class="o">=</span> <span class="p">((</span><span class="n">X_i_jk</span><span class="o">-</span><span class="n">Z_i_jk</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="n">X_i_jk</span><span class="o">-</span><span class="n">Z_i_jk</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="c1"># (X_i_jk-Z_i_jk).var()*(X_i_jk-Z_i_jk).size</span>

			<span class="n">TSS_reduced</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y_i_qr</span> <span class="o">@</span> <span class="n">Y_i_qr</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>  <span class="c1"># Y_i_qr.var()*Y_i_qr.size</span>
			<span class="n">BSS_reduced</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z_i_qr</span> <span class="o">@</span> <span class="n">Z_i_qr</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>  <span class="c1"># Z_i_qr.var()*Z_i_qr.size</span>
			<span class="n">RSS_reduced</span> <span class="o">=</span> <span class="p">((</span><span class="n">Y_i_qr</span><span class="o">-</span><span class="n">Z_i_qr</span><span class="p">)</span> <span class="o">@</span> <span class="p">(</span><span class="n">Y_i_qr</span><span class="o">-</span><span class="n">Z_i_qr</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>  <span class="c1">#  (Y_i_qr-Z_i_qr).var()*(Y_i_qr-Z_i_qr).size</span>

			<span class="c1"># pseudoF scores</span>
			<span class="n">pseudoF_full</span> <span class="o">=</span> <span class="n">PseudoF_Full</span><span class="p">(</span><span class="n">BSS_full</span><span class="p">,</span> <span class="n">RSS_full</span><span class="p">,</span> <span class="n">full_tensor_shape</span><span class="p">,</span> <span class="n">reduced_tensor_shape</span><span class="p">)</span> <span class="k">if</span> <span class="n">G</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">I</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
			<span class="n">pseudoF_reduced</span> <span class="o">=</span> <span class="n">PseudoF_Reduced</span><span class="p">(</span><span class="n">BSS_reduced</span><span class="p">,</span> <span class="n">RSS_reduced</span><span class="p">,</span> <span class="n">full_tensor_shape</span><span class="p">,</span> <span class="n">reduced_tensor_shape</span><span class="p">)</span> <span class="k">if</span> <span class="n">G</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">I</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

			<span class="c1"># output results</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
				<span class="n">BSS_percent_full</span> <span class="o">=</span> <span class="p">(</span><span class="n">BSS_full</span><span class="o">/</span><span class="n">TSS_full</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>  <span class="c1"># between cluster deviance</span>
				<span class="n">BSS_percent_reduced</span> <span class="o">=</span> <span class="p">(</span><span class="n">BSS_reduced</span><span class="o">/</span><span class="n">TSS_reduced</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>  <span class="c1"># between cluster deviance</span>
				<span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">([[]],</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="n">loop</span><span class="p">,</span> <span class="n">best_km_iter</span><span class="p">,</span> <span class="n">best_fa_iter</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">time_elapsed</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">BSS_percent_full</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">BSS_percent_reduced</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">pseudoF_full</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">pseudoF_reduced</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">km_converged</span><span class="p">,</span> <span class="n">fa_converged</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">))</span>

			<span class="c1"># tracking the best loop iterates</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
				<span class="n">B_j_q_simu</span> <span class="o">=</span> <span class="n">best_B_j_q</span>
				<span class="n">C_k_r_simu</span> <span class="o">=</span> <span class="n">best_C_k_r</span>
				<span class="n">U_i_g_simu</span> <span class="o">=</span> <span class="n">best_U_i_g</span>
				<span class="n">km_iter_simu</span> <span class="o">=</span> <span class="n">best_km_iter</span>
				<span class="n">fa_iter_simu</span> <span class="o">=</span> <span class="n">best_fa_iter</span>
				<span class="n">loop_simu</span> <span class="o">=</span> <span class="mi">1</span>
				<span class="n">km_converged_simu</span> <span class="o">=</span> <span class="n">km_converged</span>
				<span class="n">fa_converged_simu</span> <span class="o">=</span> <span class="n">fa_converged</span>
				<span class="n">Fs_fa</span> <span class="o">=</span> <span class="n">Fs_fa</span>
				<span class="n">Fs_km</span> <span class="o">=</span> <span class="n">Fs_km</span>
				<span class="n">pseudoF_full_simu</span> <span class="o">=</span> <span class="n">pseudoF_full</span>
				<span class="n">TSS_full_simu</span> <span class="o">=</span> <span class="n">TSS_full</span>
				<span class="n">BSS_full_simu</span> <span class="o">=</span> <span class="n">BSS_full</span>
				<span class="n">RSS_full_simu</span> <span class="o">=</span> <span class="n">RSS_full</span>
				<span class="n">pseudoF_reduced_simu</span> <span class="o">=</span> <span class="n">pseudoF_reduced</span>
				<span class="n">TSS_reduced_simu</span> <span class="o">=</span> <span class="n">TSS_reduced</span>
				<span class="n">BSS_reduced_simu</span> <span class="o">=</span> <span class="n">BSS_reduced</span>
				<span class="n">RSS_reduced_simu</span> <span class="o">=</span> <span class="n">RSS_reduced</span>
				<span class="n">U_i_g_init_simu</span> <span class="o">=</span> <span class="n">U_i_g_init</span>
				<span class="n">B_j_q_init_simu</span> <span class="o">=</span> <span class="n">B_j_q_init</span>
				<span class="n">C_k_r_init_simu</span> <span class="o">=</span> <span class="n">C_k_r_init</span>
				<span class="n">best_time_elapsed_simu</span> <span class="o">=</span> <span class="n">time_elapsed</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pseudoF_full</span> <span class="o">&gt;</span> <span class="n">pseudoF_full_simu</span><span class="p">):</span>
				<span class="n">pseudoF_full_simu</span> <span class="o">=</span> <span class="n">pseudoF_full</span>
				<span class="n">B_j_q_simu</span> <span class="o">=</span> <span class="n">best_B_j_q</span>
				<span class="n">C_k_r_simu</span> <span class="o">=</span> <span class="n">best_C_k_r</span>
				<span class="n">U_i_g_simu</span> <span class="o">=</span> <span class="n">best_U_i_g</span>
				<span class="n">km_iter_simu</span> <span class="o">=</span> <span class="n">best_km_iter</span>  <span class="c1"># number of iterations until convergence</span>
				<span class="n">fa_iter_simu</span> <span class="o">=</span> <span class="n">best_fa_iter</span>
				<span class="n">loop_simu</span> <span class="o">=</span> <span class="n">loop</span>  <span class="c1"># best loop so far</span>
				<span class="n">km_converged_simu</span> <span class="o">=</span> <span class="n">km_converged</span>  <span class="c1"># if there was a convergence</span>
				<span class="n">fa_converged_simu</span> <span class="o">=</span> <span class="n">fa_converged</span>  <span class="c1"># if there was a convergence</span>
				<span class="n">Fs_fa</span> <span class="o">=</span> <span class="n">Fs_fa</span>  <span class="c1"># objective function values for FA</span>
				<span class="n">Fs_km</span> <span class="o">=</span> <span class="n">Fs_km</span>
				<span class="n">TSS_full_simu</span> <span class="o">=</span> <span class="n">TSS_full</span>
				<span class="n">BSS_full_simu</span> <span class="o">=</span> <span class="n">BSS_full</span>
				<span class="n">RSS_full_simu</span> <span class="o">=</span> <span class="n">RSS_full</span>
				<span class="n">pseudoF_reduced_simu</span> <span class="o">=</span> <span class="n">pseudoF_reduced</span>
				<span class="n">TSS_reduced_simu</span> <span class="o">=</span> <span class="n">TSS_reduced</span>
				<span class="n">BSS_reduced_simu</span> <span class="o">=</span> <span class="n">BSS_reduced</span>
				<span class="n">RSS_reduced_simu</span> <span class="o">=</span> <span class="n">RSS_reduced</span>
				<span class="n">U_i_g_init_simu</span> <span class="o">=</span> <span class="n">U_i_g_init</span>
				<span class="n">B_j_q_init_simu</span> <span class="o">=</span> <span class="n">B_j_q_init</span>
				<span class="n">C_k_r_init_simu</span> <span class="o">=</span> <span class="n">C_k_r_init</span>
				<span class="n">best_time_elapsed_simu</span> <span class="o">=</span> <span class="n">time_elapsed</span>

		<span class="c1"># ----------- Result update for best loop --------------</span>

		<span class="n">Y_i_qr</span> <span class="o">=</span> <span class="n">X_i_jk</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">C_k_r_simu</span><span class="p">,</span> <span class="n">B_j_q_simu</span><span class="p">)</span>
		<span class="n">Y_g_qr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">U_i_g_simu</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">@</span> <span class="n">U_i_g_simu</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y_i_qr</span>
		<span class="n">Z_i_qr</span> <span class="o">=</span> <span class="n">U_i_g_simu</span> <span class="o">@</span> <span class="n">Y_g_qr</span>

		<span class="c1"># factor matrices and centroid matrices		</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">U_i_g0</span> <span class="o">=</span> <span class="n">U_i_g_init_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">B_j_q0</span> <span class="o">=</span> <span class="n">B_j_q_init_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">C_k_r0</span> <span class="o">=</span> <span class="n">C_k_r_init_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">U_i_g</span> <span class="o">=</span> <span class="n">U_i_g_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">B_j_q</span> <span class="o">=</span> <span class="n">B_j_q_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">C_k_r</span> <span class="o">=</span> <span class="n">C_k_r_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">Y_g_qr</span> <span class="o">=</span> <span class="n">Y_g_qr</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">X_i_jk_scaled</span> <span class="o">=</span> <span class="n">X_i_jk</span>

		<span class="c1"># total time taken</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BestTimeElapsed</span> <span class="o">=</span> <span class="n">best_time_elapsed_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BestLoop</span> <span class="o">=</span> <span class="n">loop_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BestKmIteration</span> <span class="o">=</span> <span class="n">km_iter_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BestFaIteration</span> <span class="o">=</span> <span class="n">fa_iter_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">FaConverged</span> <span class="o">=</span> <span class="n">fa_converged_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">KmConverged</span> <span class="o">=</span> <span class="n">km_converged_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nKmConverges</span> <span class="o">=</span> <span class="n">n_kmConverges</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nFaConverges</span> <span class="o">=</span> <span class="n">n_faConverges</span>

		<span class="c1"># maximum between cluster deviance</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">TSS_full</span> <span class="o">=</span> <span class="n">TSS_full_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BSS_full</span> <span class="o">=</span> <span class="n">BSS_full_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">RSS_full</span> <span class="o">=</span> <span class="n">RSS_full_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">PF_full</span> <span class="o">=</span> <span class="n">pseudoF_full</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">TSS_reduced</span> <span class="o">=</span> <span class="n">TSS_reduced_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BSS_reduced</span> <span class="o">=</span> <span class="n">BSS_reduced_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">RSS_reduced</span> <span class="o">=</span> <span class="n">RSS_reduced_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">PF_reduced</span> <span class="o">=</span> <span class="n">pseudoF_reduced</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">PF</span> <span class="o">=</span> <span class="n">pseudoF_full</span>

		<span class="c1"># Error in model</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">Enorm</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">I</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">X_i_jk</span> <span class="o">-</span> <span class="n">Z_i_qr</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">C_k_r_simu</span><span class="p">,</span> <span class="n">B_j_q_simu</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">FsKM</span> <span class="o">=</span> <span class="n">Fs_km</span>  <span class="c1"># objective values for kmeans</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">FsFA</span> <span class="o">=</span> <span class="n">Fs_fa</span>  <span class="c1"># objective values for factor decomposition</span>

		<span class="c1"># classification of objects (labels)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">Labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">U_i_g_simu</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

		<span class="k">return</span> <span class="bp">self</span></div></div>


<span class="c1"># === The TWFCTA MODEL</span>
<span class="c1"># @_doc_formatter(_doc_init_args)</span>
<div class="viewcode-block" id="TWFCTA"><a class="viewcode-back" href="../../simuclustfactor.html#simuclustfactor.tandem.TWFCTA">[docs]</a><span class="k">class</span> <span class="nc">TWFCTA</span><span class="p">(</span><span class="n">_BaseClass</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	The procedure implements sequential factorial decomposition and clustering.</span>
<span class="sd">		</span>
<span class="sd">		- The technique performs Tucker2 decomposition on the X_i_jk matrix to obtain the matrix of component scores Y_i_qr with component weights matrices B_j_q and C_k_r.</span>
<span class="sd">		- The K-means clustering algorithm is then applied to the component scores matrix Y_i_qr to obtain the desired core centroids matrix Y_g_qr and its associated stochastic membership function matrix U_i_g.</span>

<span class="sd">	:param int n_max_iter: Maximum number of iterations. Defaults to 10.</span>
<span class="sd">	:param int n_loops: Number of random initializations to gurantee global results. Defaults to 10.</span>
<span class="sd">	:param float tol: Tolerance level/acceptable error. Defaults to 1e-3.</span>
<span class="sd">	:param bool seed: Seed for random sequence generation. Defaults to None.</span>
<span class="sd">	:param bool verbose: Whether to display executions output or not. Defaults to False.</span>
<span class="sd">	:param ndarray U_i_g0: (I,G) initial stochastic membership function matrix.</span>
<span class="sd">	:param ndarray B_j_q0: (J,Q) initial component weight matrix for variables.</span>
<span class="sd">	:param ndarray C_k_r0: (K,R) initial component weight matrix for occasions.</span>

<span class="sd">	:return: Initialized TWFCTA model.</span>

<span class="sd">	.. note:: </span>
<span class="sd">		</span>
<span class="sd">		- The technique helps interpret the within clusters variability of the data. The Tucker2 tends to explain most of the total variation in the dataset. Hence, the variance of variables that do not contribute to the clustering structure in the dataset is also included.</span>
<span class="sd">		- The Tucker2 dimensions may still mask some essential clustering structures in the dataset.</span>

<span class="sd">	:references:</span>
<span class="sd">		[1] Tucker L. (1966)</span>
<span class="sd">		Some mathematical notes on three-mode factor analysis</span>
<span class="sd">		Psychometrika, 31(3), 279-311. `10.1007/BF02289464 &lt;https://doi.org/10.1007/BF02289464&gt;`_. </span>

<span class="sd">		[2] Arabie P, Hubert L (1996)</span>
<span class="sd">		Advances in Cluster Analysis Relevant to Marketing Research</span>
<span class="sd">		In: Gaul, W., Pfeifer, D. (eds) From Data to Knowledge. Studies in Classification, Data Analysis, and Knowledge Organization. Springer, Berlin, Heidelberg.</span>
<span class="sd">		`10.1007/978-3-642-79999-0_1 &lt;https://doi.org/10.1007/978-3-642-79999-0_1&gt;`_.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="o">*</span><span class="n">args</span><span class="p">,</span>
		<span class="o">**</span><span class="n">kwargs</span>
	<span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
			<span class="o">*</span><span class="n">args</span><span class="p">,</span>
			<span class="o">**</span><span class="n">kwargs</span>
		<span class="p">)</span>

	<span class="c1"># @_doc_formatter(_doc_init_attrs, _doc_refs)</span>
<div class="viewcode-block" id="TWFCTA.fit"><a class="viewcode-back" href="../../simuclustfactor.html#simuclustfactor.tandem.TWFCTA.fit">[docs]</a>	<span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_i_jk</span><span class="p">,</span> <span class="n">full_tensor_shape</span><span class="p">,</span> <span class="n">reduced_tensor_shape</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		:param ndarray X_i_jk: (I,JK) mode-1 matricized three-way arrays with frontal slabs next to each other. It is column centered.</span>
<span class="sd">		:param tuple full_tensor_shape: (I,J,K) dimensions of the original tensor.</span>
<span class="sd">		:param tuple reduced_tensor_shape: (G,Q,R) dimensions of centroids tensor.</span>
<span class="sd">		</span>
<span class="sd">		:return:</span>
<span class="sd">			- U_i_g0 - Initial object membership function matrix.</span>
<span class="sd">			- B_j_q0 - Initial factor/component matrix for the variables.</span>
<span class="sd">			- C_k_r0 - Initial factor/component matrix for the occasions.</span>
<span class="sd">			- U_i_g - Final/updated object membership function matrix.</span>
<span class="sd">			- B_j_q - Final/updated factor/component matrix for the variables.</span>
<span class="sd">			- C_k_r - Final/updated factor/component matrix for the occasions.</span>
<span class="sd">			- Y_g_qr - Derived centroids in the reduced space (data matrix).</span>
<span class="sd">			- X_i_jk_scaled - Standardized dataset matrix.</span>
<span class="sd">			- BestTimeElapsed - Execution time for the best iterate.</span>
<span class="sd">			- BestLoop - Loop that obtained the best iterate.</span>
<span class="sd">			- BestKmIteration - Number of iteration until best iterate for the K-means.</span>
<span class="sd">			- BestFaIteration - Number of iteration until best iterate for the FA.</span>
<span class="sd">			- FaConverged - Flag to check if algorithm converged for the K-means.</span>
<span class="sd">			- KmConverged - Flag to check if algorithm converged for the Factor Decomposition.</span>
<span class="sd">			- nKmConverges - Number of loops that converged for the K-means.</span>
<span class="sd">			- nFaConverges - Number of loops that converged for the Factor decomposition.</span>
<span class="sd">			- TSS_full - Total deviance in the full-space.</span>
<span class="sd">			- BSS_full - Between deviance in the reduced-space.</span>
<span class="sd">			- RSS_full - Residual deviance in the reduced-space.</span>
<span class="sd">			- PF_full - PseudoF in the full-space.</span>
<span class="sd">			- TSS_reduced - Total deviance in the reduced-space.</span>
<span class="sd">			- BSS_reduced - Between deviance in the reduced-space.</span>
<span class="sd">			- RSS_reduced - Residual deviance in the reduced-space.</span>
<span class="sd">			- PF_reduced - PseudoF in the reduced-space.</span>
<span class="sd">			- PF - Actual PseudoF value to obtain best loop.</span>
<span class="sd">			- Labels - Object cluster assignments.</span>
<span class="sd">			- FsKM - Objective function values for the KM best iterate.</span>
<span class="sd">			- FsFA - Objective function values for the FA best iterate.</span>
<span class="sd">			- Enorm - Average l2 norm of the residual norm.</span>

<span class="sd">		:Example:</span>
<span class="sd">			&gt;&gt;&gt; from generate_dataset import GenerateDataset</span>
<span class="sd">			&gt;&gt;&gt; seed = 106382</span>
<span class="sd">			&gt;&gt;&gt; full_tensor_shape = (8,5,4)</span>
<span class="sd">			&gt;&gt;&gt; reduced_tensor_shape = (3,3,2)</span>
<span class="sd">			&gt;&gt;&gt; X_i_jk = GenerateDataset(full_tensor_shape, reduced_tensor_shape, seed=seed).additive_noise().X_i_jk</span>
<span class="sd">			&gt;&gt;&gt; model = TWFCTA(verbose=False)</span>
<span class="sd">			&gt;&gt;&gt; fc = model.fit(X_i_jk, full_tensor_shape, reduced_tensor_shape)</span>
<span class="sd">			&gt;&gt;&gt; fc.Y_g_qr</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1"># ------------ Initialization ------------</span>

		<span class="c1"># initializing basic config</span>
		<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>  <span class="c1"># random number generator</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">reduced_tensor_shape</span> <span class="o">=</span> <span class="n">reduced_tensor_shape</span>  <span class="c1"># (I,J,K) tensor shape</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">full_tensor_shape</span> <span class="o">=</span> <span class="n">full_tensor_shape</span>  <span class="c1"># (G,Q,R) core tensor shape</span>

		<span class="c1"># check parameters and arguments</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_check_params</span><span class="p">()</span>
		<span class="c1"># self._check_initialized_components()</span>
		<span class="n">X_i_jk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_i_jk</span><span class="p">)</span>

		<span class="c1"># declaring I,J,K and G,Q,R</span>
		<span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span> <span class="o">=</span> <span class="n">full_tensor_shape</span>
		<span class="n">G</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="n">reduced_tensor_shape</span>

		<span class="c1"># standardizing the dataset X_i_jk</span>
		<span class="n">X_scaled</span> <span class="o">=</span> <span class="n">X_i_jk</span> <span class="o">-</span> <span class="n">X_i_jk</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">X_i_jk</span> <span class="o">=</span> <span class="n">X_scaled</span><span class="o">/</span><span class="p">((</span><span class="n">X_scaled</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">I</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

		<span class="c1"># matricize centroid tensor</span>
		<span class="n">X_k_i_j</span> <span class="o">=</span> <span class="n">Fold</span><span class="p">(</span><span class="n">X_i_jk</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">))</span>
		<span class="n">X_j_ki</span> <span class="o">=</span> <span class="n">Unfold</span><span class="p">(</span><span class="n">X_k_i_j</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">X_k_ij</span> <span class="o">=</span> <span class="n">Unfold</span><span class="p">(</span><span class="n">X_k_i_j</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

		<span class="n">I_i_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">I</span><span class="p">))</span>  <span class="c1"># identity matrix</span>

		<span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Loop&#39;</span><span class="p">,</span> <span class="s1">&#39;FA Iter&#39;</span><span class="p">,</span> <span class="s1">&#39;KM Iter&#39;</span><span class="p">,</span> <span class="s1">&#39;Loop time&#39;</span><span class="p">,</span> <span class="s1">&#39;BSS Full (%)&#39;</span><span class="p">,</span> <span class="s1">&#39;BSS Reduced (%)&#39;</span><span class="p">,</span> <span class="s1">&#39;PseudoF Full&#39;</span><span class="p">,</span> <span class="s1">&#39;PseudoF Reduced&#39;</span><span class="p">,</span> <span class="s1">&#39;FA Converged&#39;</span><span class="p">,</span> <span class="s1">&#39;KM Converged&#39;</span><span class="p">]</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">([],</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">))</span>

		<span class="n">n_faConverges</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of converges for factor analysis</span>
		<span class="n">n_kmConverges</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of converges for kmeans</span>

		<span class="c1"># number of loops</span>
		<span class="k">for</span> <span class="n">loop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_loops</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
			
			<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

			<span class="c1"># ------------ Start of initialization for FA ------------</span>

			<span class="n">fa_iter</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">Fs_fa</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># objective function values</span>
			<span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>

			<span class="c1"># as direct input</span>
			<span class="n">B_j_q0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_j_q</span>
			<span class="n">C_k_r0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_k_r</span>

			<span class="c1"># initialize B and C</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">==</span> <span class="s1">&#39;svd&#39;</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">B_j_q0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">B_j_q0</span> <span class="o">=</span> <span class="n">EigenVectors</span><span class="p">(</span><span class="n">X_j_ki</span><span class="nd">@X_j_ki</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">C_k_r0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">C_k_r0</span> <span class="o">=</span> <span class="n">EigenVectors</span><span class="p">(</span><span class="n">X_k_ij</span><span class="nd">@X_k_ij</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>  <span class="c1"># random initialization</span>
				<span class="k">if</span> <span class="n">B_j_q0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">B_rand</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">([</span><span class="n">J</span><span class="p">,</span><span class="n">J</span><span class="p">])</span>
					<span class="n">B_j_q0</span> <span class="o">=</span> <span class="n">EigenVectors</span><span class="p">(</span><span class="n">B_rand</span> <span class="o">@</span> <span class="n">B_rand</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
					<span class="k">del</span> <span class="n">B_rand</span>
				<span class="k">if</span> <span class="n">C_k_r0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">C_rand</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">([</span><span class="n">K</span><span class="p">,</span><span class="n">K</span><span class="p">])</span>
					<span class="n">C_k_r0</span> <span class="o">=</span> <span class="n">EigenVectors</span><span class="p">(</span><span class="n">C_rand</span> <span class="o">@</span> <span class="n">C_rand</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
					<span class="k">del</span> <span class="n">C_rand</span>

			<span class="c1"># to return as initializers</span>
			<span class="n">B_j_q_init</span> <span class="o">=</span> <span class="n">B_j_q0</span>
			<span class="n">C_k_r_init</span> <span class="o">=</span> <span class="n">C_k_r0</span>

			<span class="c1"># updated centroids matrix</span>
			<span class="n">Z_i_jk</span> <span class="o">=</span> <span class="n">X_i_jk</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">C_k_r0</span><span class="nd">@C_k_r0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">B_j_q0</span><span class="nd">@B_j_q0</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

			<span class="n">F0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Z_i_jk</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
			<span class="n">conv</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span>
			<span class="n">Fs_fa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F0</span><span class="p">)</span>
			<span class="n">fa_converged</span> <span class="o">=</span> <span class="kc">False</span>

			<span class="c1"># iterates init</span>
			<span class="n">best_fa_iter</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="n">best_B_j_q</span> <span class="o">=</span> <span class="n">B_j_q0</span>
			<span class="n">best_C_k_r</span> <span class="o">=</span> <span class="n">C_k_r0</span>
			
			<span class="k">while</span> <span class="p">(</span><span class="n">conv</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">):</span>

				<span class="n">fa_iter</span> <span class="o">+=</span> <span class="mi">1</span>

				<span class="c1"># ----------- Start of factor matrices update --------------</span>

				<span class="c1"># updating B_j_q</span>
				<span class="n">B_j_j</span> <span class="o">=</span> <span class="n">X_j_ki</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">I_i_i</span><span class="p">,</span> <span class="n">C_k_r0</span><span class="nd">@C_k_r0</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">@</span> <span class="n">X_j_ki</span><span class="o">.</span><span class="n">T</span>
				<span class="n">B_j_q</span> <span class="o">=</span> <span class="n">EigenVectors</span><span class="p">(</span><span class="n">B_j_j</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>

				<span class="c1"># updating C_k_r</span>
				<span class="n">C_k_k</span> <span class="o">=</span> <span class="n">X_k_ij</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">B_j_q</span><span class="nd">@B_j_q</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">I_i_i</span><span class="p">)</span> <span class="o">@</span> <span class="n">X_k_ij</span><span class="o">.</span><span class="n">T</span>
				<span class="n">C_k_r</span> <span class="o">=</span> <span class="n">EigenVectors</span><span class="p">(</span><span class="n">C_k_k</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>

				<span class="c1"># ----------- End of factor matrices update --------------</span>

				<span class="c1"># ----------- Start of objective functions update --------------</span>

				<span class="c1"># updated centroids matrix</span>
				<span class="n">Z_i_jk</span> <span class="o">=</span> <span class="n">X_i_jk</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">C_k_r</span><span class="nd">@C_k_r</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">B_j_q</span><span class="nd">@B_j_q</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
 
				<span class="c1"># compute L2 norm of reconstruction error</span>
				<span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Z_i_jk</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">conv</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">F</span><span class="o">-</span><span class="n">F0</span><span class="p">)</span>

				<span class="c1"># ----------- End of objective functions update --------------</span>

				<span class="c1"># ----------- Start stopping criteria check --------------</span>

				<span class="k">if</span> <span class="n">F</span> <span class="o">&gt;=</span> <span class="n">F0</span><span class="p">:</span>
					<span class="n">Fs_fa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
					<span class="n">F0</span> <span class="o">=</span> <span class="n">F</span>
					<span class="n">best_B_j_q</span> <span class="o">=</span> <span class="n">B_j_q</span>
					<span class="n">best_C_k_r</span> <span class="o">=</span> <span class="n">C_k_r</span>
					<span class="n">best_fa_iter</span> <span class="o">=</span> <span class="n">fa_iter</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">conv</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">):</span>
					<span class="n">fa_converged</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="n">n_faConverges</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="k">break</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">fa_iter</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_max_iter</span><span class="p">):</span>
					<span class="c1"># if self.verbose: print(&quot;FA Maximum iterations reached.&quot;)</span>
					<span class="k">break</span>

				<span class="n">B_j_q0</span> <span class="o">=</span> <span class="n">B_j_q</span>
				<span class="n">C_k_r0</span> <span class="o">=</span> <span class="n">C_k_r</span>

			<span class="c1"># ------------ Start of K-means clustering ------------</span>

			<span class="n">Y_i_qr</span> <span class="o">=</span> <span class="n">X_i_jk</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">best_C_k_r</span><span class="p">,</span> <span class="n">best_B_j_q</span><span class="p">)</span>
			<span class="n">km_iter</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">km_converged</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="n">Fs_km</span> <span class="o">=</span> <span class="p">[]</span>

			<span class="c1"># given directly as paramters</span>
			<span class="n">U_i_g0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U_i_g</span>
			<span class="k">if</span> <span class="n">U_i_g0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">U_i_g0</span> <span class="o">=</span> <span class="n">RandomMembershipMatrix</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
			
			<span class="n">U_i_g_init</span> <span class="o">=</span> <span class="n">U_i_g0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># to return as U_i_g0</span>

			<span class="c1"># initial objective</span>
			<span class="n">Y_g_qr0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">U_i_g0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">@</span> <span class="n">U_i_g0</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y_i_qr</span>  <span class="c1"># compute centroids matrix</span>
			<span class="n">F0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">U_i_g0</span><span class="nd">@Y_g_qr0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># residual matrix</span>
			<span class="n">Fs_km</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F0</span><span class="p">)</span>

			<span class="c1"># clustering on objects (via KMeans applied to X_i_jk)</span>
			<span class="n">conv</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span>

			<span class="c1"># iterates init</span>
			<span class="n">best_km_iter</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="n">best_U_i_g</span> <span class="o">=</span> <span class="n">U_i_g0</span>
			
			<span class="c1"># print(&#39;initial&#39;,U_i_g0)</span>
			<span class="k">while</span> <span class="n">conv</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">:</span>
				
				<span class="n">km_iter</span> <span class="o">+=</span> <span class="mi">1</span>

				<span class="c1"># centroids update</span>
				<span class="n">U_i_g</span> <span class="o">=</span> <span class="n">OneKMeans</span><span class="p">(</span><span class="n">Y_i_qr</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">U_i_g</span><span class="o">=</span><span class="n">U_i_g0</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>  <span class="c1"># updated membership matrix</span>
				<span class="n">Z_i_qr</span> <span class="o">=</span> <span class="n">U_i_g</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">U_i_g</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">@</span> <span class="n">U_i_g</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y_i_qr</span>  <span class="c1"># compute centroids matrix</span>
				
				<span class="c1"># check if maximizes objective</span>
				<span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Z_i_qr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># residual matrix</span>
				<span class="n">conv</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">F</span><span class="o">-</span><span class="n">F0</span><span class="p">)</span>
				
				<span class="k">if</span> <span class="n">F</span> <span class="o">&gt;=</span> <span class="n">F0</span><span class="p">:</span>
					<span class="n">Fs_km</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
					<span class="n">F0</span> <span class="o">=</span> <span class="n">F</span>			
					<span class="n">best_U_i_g</span> <span class="o">=</span> <span class="n">U_i_g</span>
					<span class="n">best_km_iter</span> <span class="o">=</span> <span class="n">km_iter</span>

				<span class="k">if</span> <span class="n">conv</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">:</span>
					<span class="n">km_converged</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="n">n_kmConverges</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="k">break</span>

				<span class="k">if</span> <span class="n">km_iter</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_max_iter</span><span class="p">:</span>
					<span class="c1"># if self.verbose: print(&quot;KM Maximum iterations reached.&quot;)</span>
					<span class="k">break</span>

				<span class="n">U_i_g0</span> <span class="o">=</span> <span class="n">U_i_g</span>  <span class="c1"># perform computation with updated U</span>

			
			<span class="c1"># ----------- Compute metrics for loop/run --------------</span>

			<span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span>

			<span class="c1"># updating X</span>
			<span class="n">X_i_jk_N</span> <span class="o">=</span> <span class="n">X_i_jk</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">best_C_k_r</span><span class="nd">@best_C_k_r</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">best_B_j_q</span><span class="nd">@best_B_j_q</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
			<span class="n">Y_i_qr</span> <span class="o">=</span> <span class="n">X_i_jk_N</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">best_C_k_r</span><span class="p">,</span> <span class="n">best_B_j_q</span><span class="p">)</span>
			<span class="n">Z_i_qr</span> <span class="o">=</span> <span class="n">best_U_i_g</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">best_U_i_g</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">@</span> <span class="n">best_U_i_g</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y_i_qr</span>
			<span class="n">Z_i_jk</span> <span class="o">=</span> <span class="n">Z_i_qr</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">best_C_k_r</span><span class="p">,</span> <span class="n">best_B_j_q</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>		
			
			<span class="n">TSS_full</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_i_jk_N</span> <span class="o">@</span> <span class="n">X_i_jk_N</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="c1"># X_i_jk@X_i_jk.size</span>
			<span class="n">BSS_full</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z_i_jk</span> <span class="o">@</span> <span class="n">Z_i_jk</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="c1"># Z_i_jk.var()*Z_i_jk.size</span>
			<span class="n">RSS_full</span> <span class="o">=</span> <span class="p">((</span><span class="n">X_i_jk_N</span><span class="o">-</span><span class="n">Z_i_jk</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="n">X_i_jk_N</span><span class="o">-</span><span class="n">Z_i_jk</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="c1"># (X_i_jk_N-Z_i_jk).var()*(X_i_jk_N-Z_i_jk).size</span>

			<span class="n">TSS_reduced</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y_i_qr</span> <span class="o">@</span> <span class="n">Y_i_qr</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>  <span class="c1"># Y_i_qr.var()*Y_i_qr.size</span>
			<span class="n">BSS_reduced</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z_i_qr</span> <span class="o">@</span> <span class="n">Z_i_qr</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>  <span class="c1"># Z_i_qr.var()*Z_i_qr.size</span>
			<span class="n">RSS_reduced</span> <span class="o">=</span> <span class="p">((</span><span class="n">Y_i_qr</span><span class="o">-</span><span class="n">Z_i_qr</span><span class="p">)</span> <span class="o">@</span> <span class="p">(</span><span class="n">Y_i_qr</span><span class="o">-</span><span class="n">Z_i_qr</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>  <span class="c1">#  (Y_i_qr-Z_i_qr).var()*(Y_i_qr-Z_i_qr).size</span>

			<span class="n">pseudoF_full</span> <span class="o">=</span> <span class="n">PseudoF_Full</span><span class="p">(</span><span class="n">BSS_full</span><span class="p">,</span> <span class="n">RSS_full</span><span class="p">,</span> <span class="n">full_tensor_shape</span><span class="p">,</span> <span class="n">reduced_tensor_shape</span><span class="p">)</span> <span class="k">if</span> <span class="n">G</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">I</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
			<span class="n">pseudoF_reduced</span> <span class="o">=</span> <span class="n">PseudoF_Reduced</span><span class="p">(</span><span class="n">BSS_reduced</span><span class="p">,</span> <span class="n">RSS_reduced</span><span class="p">,</span> <span class="n">full_tensor_shape</span><span class="p">,</span> <span class="n">reduced_tensor_shape</span><span class="p">)</span> <span class="k">if</span> <span class="n">G</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">I</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

			<span class="c1"># pseudoF and output results</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
				<span class="n">BSS_percent_full</span> <span class="o">=</span> <span class="p">(</span><span class="n">BSS_full</span><span class="o">/</span><span class="n">TSS_full</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>  <span class="c1"># between cluster deviance</span>
				<span class="n">BSS_percent_reduced</span> <span class="o">=</span> <span class="p">(</span><span class="n">BSS_reduced</span><span class="o">/</span><span class="n">TSS_reduced</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>  <span class="c1"># between cluster deviance</span>
				<span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">([[]],</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="n">loop</span><span class="p">,</span> <span class="n">best_fa_iter</span><span class="p">,</span> <span class="n">best_km_iter</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">time_elapsed</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">BSS_percent_full</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">BSS_percent_reduced</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">pseudoF_full</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">pseudoF_reduced</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">fa_converged</span><span class="p">,</span> <span class="n">km_converged</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">))</span>

			<span class="c1"># tracking the best loop iterates</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
				<span class="n">B_j_q_simu</span> <span class="o">=</span> <span class="n">best_B_j_q</span>
				<span class="n">C_k_r_simu</span> <span class="o">=</span> <span class="n">best_C_k_r</span>
				<span class="n">U_i_g_simu</span> <span class="o">=</span> <span class="n">best_U_i_g</span>
				<span class="n">km_iter_simu</span> <span class="o">=</span> <span class="n">best_km_iter</span>
				<span class="n">fa_iter_simu</span> <span class="o">=</span> <span class="n">best_fa_iter</span>
				<span class="n">loop_simu</span> <span class="o">=</span> <span class="mi">1</span>
				<span class="n">km_converged_simu</span> <span class="o">=</span> <span class="n">km_converged</span>
				<span class="n">fa_converged_simu</span> <span class="o">=</span> <span class="n">fa_converged</span>
				<span class="n">Fs_fa</span> <span class="o">=</span> <span class="n">Fs_fa</span>
				<span class="n">Fs_km</span> <span class="o">=</span> <span class="n">Fs_km</span>
				<span class="n">pseudoF_full_simu</span> <span class="o">=</span> <span class="n">pseudoF_full</span>
				<span class="n">TSS_full_simu</span> <span class="o">=</span> <span class="n">TSS_full</span>
				<span class="n">BSS_full_simu</span> <span class="o">=</span> <span class="n">BSS_full</span>
				<span class="n">RSS_full_simu</span> <span class="o">=</span> <span class="n">RSS_full</span>
				<span class="n">pseudoF_reduced_simu</span> <span class="o">=</span> <span class="n">pseudoF_reduced</span>
				<span class="n">TSS_reduced_simu</span> <span class="o">=</span> <span class="n">TSS_reduced</span>
				<span class="n">BSS_reduced_simu</span> <span class="o">=</span> <span class="n">BSS_reduced</span>
				<span class="n">RSS_reduced_simu</span> <span class="o">=</span> <span class="n">RSS_reduced</span>
				<span class="n">U_i_g_init_simu</span> <span class="o">=</span> <span class="n">U_i_g_init</span>
				<span class="n">B_j_q_init_simu</span> <span class="o">=</span> <span class="n">B_j_q_init</span>
				<span class="n">C_k_r_init_simu</span> <span class="o">=</span> <span class="n">C_k_r_init</span>
				<span class="n">best_time_elapsed_simu</span> <span class="o">=</span> <span class="n">time_elapsed</span>


			<span class="k">if</span> <span class="p">(</span><span class="n">pseudoF_reduced</span> <span class="o">&gt;</span> <span class="n">pseudoF_reduced_simu</span><span class="p">):</span>
				<span class="n">B_j_q_simu</span> <span class="o">=</span> <span class="n">best_B_j_q</span>
				<span class="n">C_k_r_simu</span> <span class="o">=</span> <span class="n">best_C_k_r</span>
				<span class="n">U_i_g_simu</span> <span class="o">=</span> <span class="n">best_U_i_g</span>
				<span class="n">km_iter_simu</span> <span class="o">=</span> <span class="n">best_km_iter</span>
				<span class="n">fa_iter_simu</span> <span class="o">=</span> <span class="n">best_fa_iter</span>
				<span class="n">loop_simu</span> <span class="o">=</span> <span class="n">loop</span>
				<span class="n">km_converged_simu</span> <span class="o">=</span> <span class="n">km_converged</span>
				<span class="n">fa_converged_simu</span> <span class="o">=</span> <span class="n">fa_converged</span>
				<span class="n">Fs_fa</span> <span class="o">=</span> <span class="n">Fs_fa</span>
				<span class="n">Fs_km</span> <span class="o">=</span> <span class="n">Fs_km</span>
				<span class="n">pseudoF_full_simu</span> <span class="o">=</span> <span class="n">pseudoF_full</span>
				<span class="n">TSS_full_simu</span> <span class="o">=</span> <span class="n">TSS_full</span>
				<span class="n">BSS_full_simu</span> <span class="o">=</span> <span class="n">BSS_full</span>
				<span class="n">RSS_full_simu</span> <span class="o">=</span> <span class="n">RSS_full</span>
				<span class="n">pseudoF_reduced_simu</span> <span class="o">=</span> <span class="n">pseudoF_reduced</span>
				<span class="n">TSS_reduced_simu</span> <span class="o">=</span> <span class="n">TSS_reduced</span>
				<span class="n">BSS_reduced_simu</span> <span class="o">=</span> <span class="n">BSS_reduced</span>
				<span class="n">RSS_reduced_simu</span> <span class="o">=</span> <span class="n">RSS_reduced</span>
				<span class="n">U_i_g_init_simu</span> <span class="o">=</span> <span class="n">U_i_g_init</span>
				<span class="n">B_j_q_init_simu</span> <span class="o">=</span> <span class="n">B_j_q_init</span>
				<span class="n">C_k_r_init_simu</span> <span class="o">=</span> <span class="n">C_k_r_init</span>
				<span class="n">best_time_elapsed_simu</span> <span class="o">=</span> <span class="n">time_elapsed</span>

		<span class="c1"># ----------- Result update for best loop --------------</span>
		<span class="n">X_i_jk_N</span> <span class="o">=</span> <span class="n">X_i_jk</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">best_C_k_r</span><span class="nd">@best_C_k_r</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">best_B_j_q</span><span class="nd">@best_B_j_q</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
		<span class="n">Y_i_qr</span> <span class="o">=</span> <span class="n">X_i_jk_N</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">C_k_r_simu</span><span class="p">,</span> <span class="n">B_j_q_simu</span><span class="p">)</span>
		<span class="n">Y_g_qr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">U_i_g_simu</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">@</span> <span class="n">U_i_g_simu</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y_i_qr</span>
		<span class="n">Z_i_qr</span> <span class="o">=</span> <span class="n">U_i_g_simu</span> <span class="o">@</span> <span class="n">Y_g_qr</span>

		<span class="c1"># factor matrices and centroid matrices</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">U_i_g</span> <span class="o">=</span> <span class="n">U_i_g_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">U_i_g0</span> <span class="o">=</span> <span class="n">U_i_g_init_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">B_j_q0</span> <span class="o">=</span> <span class="n">B_j_q_init_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">C_k_r0</span> <span class="o">=</span> <span class="n">C_k_r_init_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">B_j_q</span> <span class="o">=</span> <span class="n">B_j_q_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">C_k_r</span> <span class="o">=</span> <span class="n">C_k_r_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">Y_g_qr</span> <span class="o">=</span> <span class="n">Y_g_qr</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">X_i_jk_scaled</span> <span class="o">=</span> <span class="n">X_i_jk_N</span>

		<span class="c1"># total time taken</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BestTimeElapsed</span> <span class="o">=</span> <span class="n">best_time_elapsed_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BestLoop</span> <span class="o">=</span> <span class="n">loop_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BestKMIteration</span> <span class="o">=</span> <span class="n">km_iter_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BestFAIteration</span> <span class="o">=</span> <span class="n">fa_iter_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">FaConverged</span> <span class="o">=</span> <span class="n">fa_converged_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">KmConverged</span> <span class="o">=</span> <span class="n">km_converged_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nKmConverges</span> <span class="o">=</span> <span class="n">n_kmConverges</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nFaConverges</span> <span class="o">=</span> <span class="n">n_faConverges</span>

		<span class="c1"># maximum between cluster deviance</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">TSS_full</span> <span class="o">=</span> <span class="n">TSS_full_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BSS_full</span> <span class="o">=</span> <span class="n">BSS_full_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">RSS_full</span> <span class="o">=</span> <span class="n">RSS_full_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">PF_full</span> <span class="o">=</span> <span class="n">pseudoF_full</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">TSS_reduced</span> <span class="o">=</span> <span class="n">TSS_reduced_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BSS_reduced</span> <span class="o">=</span> <span class="n">BSS_reduced_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">RSS_reduced</span> <span class="o">=</span> <span class="n">RSS_reduced_simu</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">PF_reduced</span> <span class="o">=</span> <span class="n">pseudoF_reduced</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">PF</span> <span class="o">=</span> <span class="n">pseudoF_reduced</span>

		<span class="c1"># Error in model</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">FsKM</span> <span class="o">=</span> <span class="n">Fs_km</span>  <span class="c1"># all objective values</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">FsFA</span> <span class="o">=</span> <span class="n">Fs_fa</span>  <span class="c1"># all objectiveh values for Factor Analysis</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">Enorm</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">I</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">X_i_jk</span> <span class="o">-</span> <span class="n">Z_i_qr</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">C_k_r_simu</span><span class="p">,</span> <span class="n">B_j_q_simu</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
		
		<span class="c1"># classification of objects (labels)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">Labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">U_i_g_simu</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

		<span class="c1"># ----------- End of result update for best loop --------------</span>

		<span class="k">return</span> <span class="bp">self</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Prosper Ablordeppey.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>